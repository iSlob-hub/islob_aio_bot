{% extends "base.html" %}

{% block title %}–ü—Ä–æ—Ñ—ñ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞{% endblock %}

{% block extra_css %}
<style>
.payment-info {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-left: 4px solid #007bff;
    border-radius: 8px;
    padding: 20px;
    margin: 20px 0;
}
.payment-badge {
    font-size: 1.1em;
    padding: 8px 16px;
}
.payment-actions {
    margin-top: 15px;
}
.payment-actions .btn {
    margin: 5px;
}
.country-search-wrapper {
    position: relative;
    margin-bottom: 10px;
}
.country-search-wrapper .clear-search {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #6c757d;
    cursor: pointer;
    font-size: 18px;
    padding: 0;
    width: 20px;
    height: 20px;
    display: none;
}
.country-search-wrapper .clear-search:hover {
    color: #dc3545;
}
.preview-box {
    white-space: pre-wrap;
    background: linear-gradient(135deg, #fdfdfd, #f5f7fa);
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    font-family: "Menlo", "Consolas", monospace;
}
.upload-spinner {
    display: none;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
    color: #0d6efd;
    font-weight: 600;
}
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const countrySelect = document.getElementById('countrySelect');
    const timezoneOffset = document.getElementById('timezoneOffset');
    const countrySearch = document.getElementById('countrySearch');
    const clearSearchBtn = document.getElementById('clearSearch');
    
    // Store all options for filtering
    const allOptions = Array.from(countrySelect.options).slice(1); // Skip first "-- –û–±–µ—Ä—ñ—Ç—å –∫—Ä–∞—ó–Ω—É --"
    
    // Update hidden field when country is selected
    countrySelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const offset = selectedOption.getAttribute('data-offset');
        if (offset) {
            timezoneOffset.value = offset;
        }
    });
    
    // Search functionality
    countrySearch.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        
        // Show/hide clear button
        clearSearchBtn.style.display = searchTerm ? 'block' : 'none';
        
        // Clear all options except the first one
        countrySelect.innerHTML = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å –∫—Ä–∞—ó–Ω—É --</option>';
        
        if (searchTerm === '') {
            // If search is empty, show all options
            allOptions.forEach(option => {
                countrySelect.appendChild(option.cloneNode(true));
            });
        } else {
            // Filter and show matching options
            const filteredOptions = allOptions.filter(option => {
                const optionText = option.textContent.toLowerCase();
                return optionText.includes(searchTerm);
            });
            
            filteredOptions.forEach(option => {
                countrySelect.appendChild(option.cloneNode(true));
            });
            
            // Show message if no results
            if (filteredOptions.length === 0) {
                const noResultOption = document.createElement('option');
                noResultOption.textContent = '–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ';
                noResultOption.disabled = true;
                countrySelect.appendChild(noResultOption);
            }
        }
    });
    
    // Clear search
    clearSearchBtn.addEventListener('click', function() {
        countrySearch.value = '';
        countrySearch.dispatchEvent(new Event('input'));
        countrySearch.focus();
    });

    // Spinner for training upload
    const uploadForm = document.getElementById('uploadTrainingForm');
    const uploadSpinner = document.getElementById('uploadSpinner');
    const uploadSpinnerText = document.getElementById('uploadSpinnerText');
    const uploadBtn = document.getElementById('uploadSubmitBtn');
    const uploadIcon = document.getElementById('uploadIcon');
    const uploadBtnText = document.getElementById('uploadBtnText');
    const previewCollapseEl = document.getElementById('trainingPreviewCollapse');
    const togglePreviewBtn = document.getElementById('togglePreviewBtn');
    const previewToggleIcon = document.getElementById('previewToggleIcon');
    const previewToggleText = document.getElementById('previewToggleText');
    const scheduledAtKyivInput = document.getElementById('scheduleModalDatetime');
    const userTimeDisplay = document.getElementById('scheduleUserTime');
    const userOffsetHours = {{ user.timezone_offset or 0 }};
    const scheduledPreviewMap = {};
    {% if scheduled_deliveries %}
    {% for item in scheduled_deliveries %}
    scheduledPreviewMap["{{ item.id }}"] = {{ (item.training_preview or "") | tojson }};
    {% endfor %}
    {% endif %}

    if (uploadForm) {
        uploadForm.addEventListener('submit', function() {
            if (uploadSpinner) uploadSpinner.classList.remove('d-none');
            if (uploadSpinnerText) uploadSpinnerText.style.display = 'flex';
            if (uploadIcon) uploadIcon.classList.add('d-none');
            if (uploadBtnText) uploadBtnText.textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
            if (uploadBtn) {
                uploadBtn.disabled = true;
                uploadBtn.classList.add('disabled');
            }
        });
    }

    if (previewCollapseEl && togglePreviewBtn && previewToggleIcon && previewToggleText) {
        const setExpanded = (expanded) => {
            togglePreviewBtn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
            if (expanded) {
                togglePreviewBtn.classList.remove('btn-outline-secondary');
                togglePreviewBtn.classList.add('btn-secondary');
                previewToggleIcon.textContent = '‚ûñ';
                previewToggleText.textContent = '–°—Ö–æ–≤–∞—Ç–∏ –ø—Ä–µ–≤ º—é';
            } else {
                togglePreviewBtn.classList.add('btn-outline-secondary');
                togglePreviewBtn.classList.remove('btn-secondary');
                previewToggleIcon.textContent = '‚ûï';
                previewToggleText.textContent = '–ü–æ–∫–∞–∑–∞—Ç–∏ –ø—Ä–µ–≤ º—é';
            }
        };

        previewCollapseEl.addEventListener('show.bs.collapse', () => setExpanded(true));
        previewCollapseEl.addEventListener('hide.bs.collapse', () => setExpanded(false));
    }

    const updateUserLocalTime = () => {
        if (!scheduledAtKyivInput || !userTimeDisplay) return;
        const value = scheduledAtKyivInput.value;
        if (!value) {
            userTimeDisplay.textContent = '‚Äî';
            return;
        }
        const [datePart, timePart] = value.split('T');
        if (!datePart || !timePart) {
            userTimeDisplay.textContent = '–ù–µ–≤—ñ—Ä–Ω–∏–π —á–∞—Å';
            return;
        }
        const [year, month, day] = datePart.split('-').map(Number);
        const [hour, minute] = timePart.split(':').map(Number);
        const baseUtc = new Date(Date.UTC(year, month - 1, day, hour, minute));
        baseUtc.setUTCHours(baseUtc.getUTCHours() + userOffsetHours);
        const pad = (n) => String(n).padStart(2, '0');
        const display = `${baseUtc.getUTCFullYear()}-${pad(baseUtc.getUTCMonth() + 1)}-${pad(baseUtc.getUTCDate())} ${pad(baseUtc.getUTCHours())}:${pad(baseUtc.getUTCMinutes())}`;
        userTimeDisplay.textContent = display;
    };

    if (scheduledAtKyivInput) {
        const pad = (n) => String(n).padStart(2, '0');
        const now = new Date();
        now.setMinutes(now.getMinutes() + 60);
        const defaultValue = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
        if (!scheduledAtKyivInput.value) {
            scheduledAtKyivInput.value = defaultValue;
        }
        updateUserLocalTime();
        scheduledAtKyivInput.addEventListener('input', updateUserLocalTime);
    }

    // Scheduled preview modal
    const scheduledPreviewButtons = document.querySelectorAll('.scheduled-preview-btn');
    const scheduledPreviewDeliveryId = document.getElementById('scheduledPreviewDeliveryId');
    const scheduledPreviewTextarea = document.getElementById('scheduledPreviewTextarea');
    const scheduledPreviewRender = document.getElementById('scheduledPreviewRender');
    const scheduledPreviewRefreshBtn = document.getElementById('scheduledPreviewRefreshBtn');

    const renderScheduledPreview = () => {
        if (!scheduledPreviewRender || !scheduledPreviewTextarea) return;
        scheduledPreviewRender.innerHTML = scheduledPreviewTextarea.value || '‚Äî';
    };

    scheduledPreviewButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const id = btn.dataset.deliveryId;
            if (scheduledPreviewDeliveryId) scheduledPreviewDeliveryId.value = id;
            if (scheduledPreviewTextarea) scheduledPreviewTextarea.value = scheduledPreviewMap[id] || '';
            renderScheduledPreview();
        });
    });

    if (scheduledPreviewRefreshBtn) {
        scheduledPreviewRefreshBtn.addEventListener('click', renderScheduledPreview);
    }
});
</script>
{% endblock %}

{% block content %}
<div class="card shadow-sm mx-auto" style="max-width: 800px;">
    <div class="card-body">
        <h2 class="card-title">–ü—Ä–æ—Ñ—ñ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</h2>
        <div class="row">
            <div class="col-md-6">
                <p><strong>Telegram ID:</strong> {{ user.telegram_id }}</p>
                <p><strong>–ü–æ–≤–Ω–µ —ñ–º'—è:</strong> {{ user.full_name }}</p>
                <p><strong>Username:</strong> @{{ user.telegram_username }}</p>
                <p><strong>–¶—ñ–ª—å —Ç—Ä–µ–Ω—É–≤–∞–Ω—å:</strong> {{ user.training_goal.value }}</p>
                <p>
                    <strong>–°—Ç–∞—Ç—É—Å:</strong>
                    {% if user.is_verified %}‚úÖ –í–µ—Ä–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π {% else %}‚ùå –ù–µ –≤–µ—Ä–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π{% endif %}
                    /
                    {% if user.is_active %}üü¢ –ê–∫—Ç–∏–≤–Ω–∏–π{% else %}üî¥ –ù–µ–∞–∫—Ç–∏–≤–Ω–∏–π{% endif %}
                </p>
            </div>
            
            <div class="col-md-6">
                <!-- –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –æ–ø–ª–∞—Ç—É -->
                <div class="payment-info">
                    <h5><i class="fas fa-credit-card"></i> –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –æ–ø–ª–∞—Ç—É</h5>
                    
                    <div class="mb-3">
                        {% if user.payed_days_left == -1 %}
                            <span class="badge bg-info payment-badge">‚ôæÔ∏è –ë–µ–∑–ª—ñ–º—ñ—Ç–Ω–∏–π –¥–æ—Å—Ç—É–ø</span>
                        {% elif user.payed_days_left == 0 %}
                            <span class="badge bg-secondary payment-badge">‚è∞ –û–ø–ª–∞—Ç–∞ –∑–∞–∫—ñ–Ω—á–∏–ª–∞—Å—å</span>
                        {% elif user.payed_days_left == 1 %}
                            <span class="badge bg-danger payment-badge">‚ö†Ô∏è –ó–∞–ª–∏—à–∏–≤—Å—è 1 –¥–µ–Ω—å</span>
                        {% elif user.payed_days_left <= 7 %}
                            <span class="badge bg-warning payment-badge">‚è∞ –ó–∞–ª–∏—à–∏–ª–æ—Å—å {{ user.payed_days_left }} –¥–Ω—ñ–≤</span>
                        {% else %}
                            <span class="badge bg-success payment-badge">‚úÖ –ó–∞–ª–∏—à–∏–ª–æ—Å—å {{ user.payed_days_left }} –¥–Ω—ñ–≤</span>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <strong>–°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç–∏:</strong>
                        {% if user.paused_payment %}
                            <span class="badge bg-dark">‚è∏Ô∏è –ù–∞ –ø–∞—É–∑—ñ</span>
                        {% else %}
                            <span class="badge bg-success">‚ñ∂Ô∏è –ê–∫—Ç–∏–≤–Ω–∞</span>
                        {% endif %}
                    </div>
                    
                    <div class="payment-actions">
                        <div class="row">
                            <div class="col-12 mb-2">
                                {% if user.paused_payment %}
                                    <form method="post" action="/resume-payment?telegram_id={{ user.telegram_id }}" style="display: inline;">
                                        <button type="submit" class="btn btn-success btn-sm">
                                            <i class="fas fa-play"></i> –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –æ–ø–ª–∞—Ç—É
                                        </button>
                                    </form>
                                {% else %}
                                    <form method="post" action="/pause-payment?telegram_id={{ user.telegram_id }}" style="display: inline;">
                                        <button type="submit" class="btn btn-warning btn-sm">
                                            <i class="fas fa-pause"></i> –ü–æ—Å—Ç–∞–≤–∏—Ç–∏ –Ω–∞ –ø–∞—É–∑—É
                                        </button>
                                    </form>
                                {% endif %}
                            </div>
                            
                            <div class="col-12">
                                <div class="btn-group-vertical w-100" role="group">
                                    <form method="post" action="/add-payment?telegram_id={{ user.telegram_id }}&days=7" style="display: inline;">
                                        <button type="submit" class="btn btn-outline-primary btn-sm w-100 mb-1">
                                            <i class="fas fa-plus"></i> +7 –¥–Ω—ñ–≤
                                        </button>
                                    </form>
                                    
                                    <form method="post" action="/add-payment?telegram_id={{ user.telegram_id }}&days=28" style="display: inline;">
                                        <button type="submit" class="btn btn-primary btn-sm w-100 mb-1">
                                            <i class="fas fa-plus"></i> +28 –¥–Ω—ñ–≤ (1 –º—ñ—Å—è—Ü—å)
                                        </button>
                                    </form>
                                    
                                    <form method="post" action="/add-payment?telegram_id={{ user.telegram_id }}&days=84" style="display: inline;">
                                        <button type="submit" class="btn btn-outline-primary btn-sm w-100 mb-1">
                                            <i class="fas fa-plus"></i> +84 –¥–Ω—ñ (3 –º—ñ—Å—è—Ü—ñ)
                                        </button>
                                    </form>
                                    
                                    {% if user.payed_days_left != -1 %}
                                    <form method="post" action="/set-unlimited?telegram_id={{ user.telegram_id }}" style="display: inline;">
                                        <button type="submit" class="btn btn-info btn-sm w-100" 
                                                onclick="return confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –±–µ–∑–ª—ñ–º—ñ—Ç–Ω–∏–π –¥–æ—Å—Ç—É–ø?')">
                                            <i class="fas fa-infinity"></i> –ë–µ–∑–ª—ñ–º—ñ—Ç–Ω–∏–π –¥–æ—Å—Ç—É–ø
                                        </button>
                                    </form>
                                    {% else %}
                                    <hr class="my-2">
                                    <small class="text-muted">–í—ñ–¥–º—ñ–Ω–∞ –±–µ–∑–ª—ñ–º—ñ—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø—É:</small>
                                    <form method="post" action="/cancel-unlimited?telegram_id={{ user.telegram_id }}&days=28" style="display: inline;">
                                        <button type="submit" class="btn btn-outline-warning btn-sm w-100 mb-1" 
                                                onclick="return confirm('–í—ñ–¥–º—ñ–Ω–∏—Ç–∏ –±–µ–∑–ª—ñ–º—ñ—Ç–Ω–∏–π –¥–æ—Å—Ç—É–ø —ñ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ 28 –¥–Ω—ñ–≤?')">
                                            <i class="fas fa-times-circle"></i> –í—ñ–¥–º—ñ–Ω–∏—Ç–∏ (28 –¥–Ω—ñ–≤)
                                        </button>
                                    </form>
                                    <form method="post" action="/cancel-unlimited?telegram_id={{ user.telegram_id }}&days=0" style="display: inline;">
                                        <button type="submit" class="btn btn-outline-danger btn-sm w-100" 
                                                onclick="return confirm('–í—ñ–¥–º—ñ–Ω–∏—Ç–∏ –±–µ–∑–ª—ñ–º—ñ—Ç–Ω–∏–π –¥–æ—Å—Ç—É–ø —ñ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ 0 –¥–Ω—ñ–≤ (–∑–∞–±–ª–æ–∫—É–≤–∞—Ç–∏)?')">
                                            <i class="fas fa-ban"></i> –í—ñ–¥–º—ñ–Ω–∏—Ç–∏ (0 –¥–Ω—ñ–≤)
                                        </button>
                                    </form>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <hr class="my-4">
        
        <div class="mb-3">
            <a class="btn btn-primary" href="/training-sessions?telegram_id={{ user.telegram_id }}">–¢—Ä–µ–Ω—É–≤–∞–Ω–Ω—è</a>
            <a class="btn btn-secondary" href="/morning-quiz?telegram_id={{ user.telegram_id }}">–†–∞–Ω–∫–æ–≤—ñ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è</a>
            <a class="btn btn-success" href="/statistics?telegram_id={{ user.telegram_id }}">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
            <a class="btn btn-warning" href="/notifications?telegram_id={{ user.telegram_id }}">–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è</a>
        </div>

        <hr class="my-4">

        <!-- –ß–∞—Å–æ–≤–∞ –∑–æ–Ω–∞ —Ç–∞ –∫—Ä–∞—ó–Ω–∞ -->
        <h3><i class="fas fa-globe"></i> –ß–∞—Å–æ–≤–∞ –∑–æ–Ω–∞</h3>
        
        <div class="mb-4">
            {% if user.country and user.timezone_offset is not none %}
                <div class="alert alert-info">
                    <strong>–ü–æ—Ç–æ—á–Ω–∞ –∫—Ä–∞—ó–Ω–∞:</strong> {{ user.country }}<br>
                    <strong>–†—ñ–∑–Ω–∏—Ü—è –∑ –ö–∏—î–≤–æ–º:</strong> 
                    {% if user.timezone_offset > 0 %}
                        +{{ user.timezone_offset }} –≥–æ–¥–∏–Ω
                    {% elif user.timezone_offset < 0 %}
                        {{ user.timezone_offset }} –≥–æ–¥–∏–Ω
                    {% else %}
                        –ö–∏—ó–≤—Å—å–∫–∏–π —á–∞—Å (–±–µ–∑ —Ä—ñ–∑–Ω–∏—Ü—ñ)
                    {% endif %}
                </div>
            {% else %}
                <div class="alert alert-warning">
                    ‚ö†Ô∏è –ß–∞—Å–æ–≤–∞ –∑–æ–Ω–∞ –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
                </div>
            {% endif %}
            
            <form method="post" action="/update-timezone?telegram_id={{ user.telegram_id }}" id="timezoneForm">
                <div class="mb-3">
                    <label for="country" class="form-label">–í–∏–±–µ—Ä—ñ—Ç—å –∫—Ä–∞—ó–Ω—É –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è:</label>
                    
                    <!-- –ü–æ–ª–µ –ø–æ—à—É–∫—É -->
                    <div class="country-search-wrapper">
                        <input type="text" 
                               id="countrySearch" 
                               class="form-control mb-2" 
                               placeholder="üîç –ü–æ—à—É–∫ –∫—Ä–∞—ó–Ω–∏..." 
                               autocomplete="off">
                        <button type="button" id="clearSearch" class="clear-search" title="–û—á–∏—Å—Ç–∏—Ç–∏ –ø–æ—à—É–∫">
                            ‚úï
                        </button>
                    </div>
                    
                    <select name="country" id="countrySelect" class="form-select" required size="8">
                        {% for c in countries %}
                        <option value="{{ c.country }}" data-offset="{{ c.offset }}"
                                {% if user.country == c.country %}selected{% endif %}>
                            {{ c.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <input type="hidden" name="timezone_offset" id="timezoneOffset" value="0">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-clock"></i> –û–Ω–æ–≤–∏—Ç–∏ —á–∞—Å–æ–≤—É –∑–æ–Ω—É
                </button>
            </form>
        </div>

        <hr class="my-4">

        <h3><i class="fas fa-file-alt"></i> –§–∞–π–ª —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è</h3>

        {% if schedule_status == 'success' %}
        <div class="alert alert-success">
            {{ schedule_message or "–†–æ–∑—Å–∏–ª–∫—É –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ." }}
        </div>
        {% elif schedule_status == 'error' %}
        <div class="alert alert-danger">
            {{ schedule_message or "–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–ø–ª–∞–Ω—É–≤–∞—Ç–∏ —Ä–æ–∑—Å–∏–ª–∫—É." }}
        </div>
        {% endif %}

        <div class="mb-4">
        {% if user.training_file_url %}
            <div class="alert alert-success d-flex justify-content-between align-items-center">
            <div>
                <strong>‚úÖ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ:</strong>
                <a href="{{ user.training_file_url }}" target="_blank" class="ms-2">
                {{ user.training_file_url.split('/')[-1] }}
                </a>
            </div>
            <button class="btn btn-outline-dark btn-sm"
                    onclick="navigator.clipboard.writeText(window.location.origin + '{{ user.training_file_url }}')">
            üìã –°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è
            </button>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è -->
            <form action="/notify-training-assigned?telegram_id={{ user.telegram_id }}" method="post" class="mt-3">
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-paper-plane"></i> –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
                </button>
            </form>
        {% else %}
            <div class="alert alert-warning">
            üö´ –§–∞–π–ª —â–µ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ.
            </div>
        {% endif %}

        <form id="uploadTrainingForm" action="/upload-training-file?user_telegram_id={{ user.telegram_id }}" method="post" enctype="multipart/form-data" class="mt-3">
            <div class="mb-3">
            <label for="file" class="form-label">–í–∏–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</label>
            <input type="file" name="file" id="file" class="form-control" required>
            </div>
            <div class="d-flex align-items-center gap-2">
                <button type="submit" class="btn btn-primary" id="uploadSubmitBtn">
                    <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true" id="uploadSpinner"></span>
                    <i class="fas fa-upload" id="uploadIcon"></i>
                    <span id="uploadBtnText">–ü—Ä–∏—Å–≤–æ—ó—Ç–∏ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è</span>
                </button>
                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#scheduleModal" {% if not user.training_file_url %}disabled{% endif %}>
                    <i class="fas fa-calendar-alt"></i> –ó–∞–ø–ª–∞–Ω—É–≤–∞—Ç–∏ –≤—ñ–¥–ø—Ä–∞–≤–∫—É
                </button>
            </div>
            <div class="upload-spinner" id="uploadSpinnerText">
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Ñ–∞–π–ª —Ç–∞ –≥–µ–Ω–µ—Ä—É—î–º–æ –ø—Ä–µ–≤ º—é...
            </div>
        </form>

        <!-- –ú–æ–¥–∞–ª–∫–∞ –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è -->
        <div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="scheduleModalLabel">–ó–∞–ø–ª–∞–Ω—É–≤–∞—Ç–∏ –≤—ñ–¥–ø—Ä–∞–≤–∫—É</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form method="post" action="/schedule-training-delivery">
                        <div class="modal-body">
                            <input type="hidden" name="telegram_id" value="{{ user.telegram_id }}">
                            <div class="mb-3">
                                <label for="scheduleModalDatetime" class="form-label">–î–∞—Ç–∞ —Ç–∞ —á–∞—Å (–ö–∏—ó–≤)</label>
                                <input type="datetime-local" class="form-control" id="scheduleModalDatetime" name="scheduled_at_kyiv" required>
                                <div class="form-text">–ß–∞—Å –∫–ª—ñ—î–Ω—Ç–∞: <span id="scheduleUserTime">‚Äî</span> (–æ—Ñ—Å–µ—Ç {{ user.timezone_offset or 0 }} –≥–æ–¥ –≤—ñ–¥ –ö–∏—î–≤–∞)</div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä–∏—Ç–∏</button>
                            <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> –ó–∞–ø–ª–∞–Ω—É–≤–∞—Ç–∏</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª–∫–∞ –ø—Ä–µ–≤ º—é –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ—ó –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ -->
        <div class="modal fade" id="scheduledPreviewModal" tabindex="-1" aria-labelledby="scheduledPreviewModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="scheduledPreviewModalLabel">–ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–µ –ø—Ä–µ–≤ º—é</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form method="post" action="/update-scheduled-preview">
                        <div class="modal-body">
                            <input type="hidden" name="telegram_id" value="{{ user.telegram_id }}">
                            <input type="hidden" name="delivery_id" id="scheduledPreviewDeliveryId">
                            <div class="mb-3">
                                <label for="scheduledPreviewTextarea" class="form-label">HTML (–¥–æ—Å—Ç—É–ø–Ω—ñ &lt;b&gt;, &lt;i&gt;, &lt;a&gt;)</label>
                                <textarea class="form-control" id="scheduledPreviewTextarea" name="preview_html" rows="10"></textarea>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="form-text">–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥ (Telegram HTML)</div>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="scheduledPreviewRefreshBtn">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏</button>
                            </div>
                            <div class="border rounded p-3 bg-light" id="scheduledPreviewRender" style="min-height:120px; white-space:pre-line;"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä–∏—Ç–∏</button>
                            <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> –ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        {% if scheduled_deliveries %}
        <div class="card mt-3">
            <div class="card-header">–ú–∞–π–±—É—Ç–Ω—ñ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏</div>
            <ul class="list-group list-group-flush">
                {% for item in scheduled_deliveries %}
                {% set status_value = item.status.value if item.status is not string else item.status %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <div><strong>–ö–∏—ó–≤:</strong> {{ item.send_at.strftime('%Y-%m-%d %H:%M') if item.send_at else '‚Äî' }}</div>
                        <div class="small text-muted"><strong>–ß–∞—Å –∫–ª—ñ—î–Ω—Ç–∞:</strong> {{ item.send_at_user_time.strftime('%Y-%m-%d %H:%M') if item.send_at_user_time else '‚Äî' }}</div>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge {% if status_value == 'pending' %}bg-warning text-dark{% elif status_value == 'sent' %}bg-success{% elif status_value == 'cancelled' %}bg-secondary{% else %}bg-danger{% endif %}">
                            {{ status_value }}
                        </span>
                        <button type="button" class="btn btn-outline-info btn-sm scheduled-preview-btn" data-delivery-id="{{ item.id }}" data-bs-toggle="modal" data-bs-target="#scheduledPreviewModal">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –ø—Ä–µ–≤ º—é</button>
                        {% if status_value == 'pending' %}
                            <form method="post" action="/cancel-scheduled-training" class="m-0">
                                <input type="hidden" name="telegram_id" value="{{ user.telegram_id }}">
                                <input type="hidden" name="delivery_id" value="{{ item.id }}">
                                <button type="submit" class="btn btn-outline-danger btn-sm">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                            </form>
                        {% else %}
                            <form method="post" action="/delete-scheduled-training" class="m-0">
                                <input type="hidden" name="telegram_id" value="{{ user.telegram_id }}">
                                <input type="hidden" name="delivery_id" value="{{ item.id }}">
                                <button type="submit" class="btn btn-outline-secondary btn-sm">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                            </form>
                        {% endif %}
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        </div>

        <h3><i class="fas fa-eye"></i> –ü—Ä–µ–≤ º—é —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è</h3>

        {% if preview_status == 'success' %}
        <div class="alert alert-success">
            {{ preview_message or "–ü—Ä–µ–≤ º—é –æ–Ω–æ–≤–ª–µ–Ω–æ." }}
        </div>
        {% elif preview_status == 'error' %}
        <div class="alert alert-danger">
            {{ preview_message or "–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –ø—Ä–µ–≤ º—é." }}
        </div>
        {% endif %}

        <div class="card mb-3">
        <div class="card-header">
            –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–µ–≤ º—é –≤—Ä—É—á–Ω—É
        </div>
        <div class="card-body">
            <form action="/update-training-preview" method="post">
                <input type="hidden" name="telegram_id" value="{{ user.telegram_id }}">
                <div class="mb-3">
                    <label for="previewHtml" class="form-label">HTML –¥–ª—è –ø—Ä–µ–≤ º—é (–¥–æ—Å—Ç—É–ø–Ω—ñ —Ç–µ–≥–∏ &lt;b&gt;, &lt;i&gt;, &lt;a&gt;)</label>
                    <textarea class="form-control" id="previewHtml" name="preview_html" rows="10" placeholder="–í–≤–µ–¥—ñ—Ç—å HTML –ø—Ä–µ–≤ º—é">{{ user.training_preview or '' }}</textarea>
                    <div class="form-text">–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∑–º—ñ–Ω –æ–¥—Ä–∞–∑—É –æ–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–≤ º—é —É –±–æ—Ç—ñ.</div>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> –ó–±–µ—Ä–µ–≥—Ç–∏ –ø—Ä–µ–≤ º—é
                </button>
            </form>
        </div>
        </div>

        {% if user.training_preview %}
        <button class="btn btn-outline-secondary btn-sm mb-2" type="button"
                data-bs-toggle="collapse" data-bs-target="#trainingPreviewCollapse"
                aria-expanded="false" aria-controls="trainingPreviewCollapse"
                id="togglePreviewBtn">
            <span id="previewToggleIcon">‚ûï</span> <span id="previewToggleText">–ü–æ–∫–∞–∑–∞—Ç–∏ –ø—Ä–µ–≤ º—é</span>
        </button>
        <div class="collapse" id="trainingPreviewCollapse">
        <div class="card mb-3">
            <div class="card-body preview-box">
                {{ user.training_preview | safe }}
            </div>
            {% if user.training_preview_generated_at %}
            <div class="card-footer text-muted">
                –û–Ω–æ–≤–ª–µ–Ω–æ: {{ user.training_preview_generated_at.strftime('%Y-%m-%d %H:%M') }}
            </div>
            {% endif %}
        </div>
        </div>
        {% elif user.training_preview_error %}
        <div class="alert alert-danger">
            ‚ùå –ü–æ–º–∏–ª–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –ø—Ä–µ–≤ º—é: {{ user.training_preview_error }}
        </div>
        {% elif user.training_file_url %}
        <div class="alert alert-info">
            ‚è≥ –ü—Ä–µ–≤ º—é –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è. –Ø–∫—â–æ –≤–æ–Ω–æ –Ω–µ –∑ º—è–≤–∏—Ç—å—Å—è, —Å–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª.
        </div>
        {% else %}
        <div class="alert alert-secondary">
            –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Ç—Ä–µ–Ω—É–≤–∞–ª—å–Ω–∏–π —Ñ–∞–π–ª, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–µ–≤ º—é.
        </div>
        {% endif %}

        <hr class="my-4">

        <h4><i class="fas fa-history"></i> –Ü—Å—Ç–æ—Ä—ñ—è –≤—ñ–¥–ø—Ä–∞–≤–æ–∫ —Ñ–∞–π–ª—ñ–≤</h4>
        {% set history = (user.training_file_history or []) | sort(attribute='sent_at', reverse=True) %}
        {% if history %}
        <ul class="list-group mb-3">
            {% for item in history %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <div class="fw-bold">{{ item.filename }}</div>
                    {% if item.file_url %}
                    <div class="small text-muted">{{ item.file_url }}</div>
                    {% endif %}
                </div>
                <span class="badge bg-light text-dark">
                    {{ item.sent_at.strftime('%Y-%m-%d %H:%M') }}
                </span>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <div class="alert alert-secondary">
            –Ü—Å—Ç–æ—Ä—ñ—è –≤—ñ–¥–ø—Ä–∞–≤–æ–∫ –ø–æ–∫–∏ –ø–æ—Ä–æ–∂–Ω—è.
        </div>
        {% endif %}

    </div>
</div>
{% endblock %}
