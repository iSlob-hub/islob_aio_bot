{% extends "base.html" %}

{% block title %}–ü—Ä–æ—Ñ—ñ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞{% endblock %}

{% block extra_css %}
<style>
.payment-info {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-left: 4px solid #007bff;
    border-radius: 8px;
    padding: 20px;
    margin: 20px 0;
}
.payment-badge {
    font-size: 1.1em;
    padding: 8px 16px;
}
.payment-actions {
    margin-top: 15px;
}
.payment-actions .btn {
    margin: 5px;
}
.country-search-wrapper {
    position: relative;
    margin-bottom: 10px;
}
.country-search-wrapper .clear-search {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #6c757d;
    cursor: pointer;
    font-size: 18px;
    padding: 0;
    width: 20px;
    height: 20px;
    display: none;
}
.country-search-wrapper .clear-search:hover {
    color: #dc3545;
}
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const countrySelect = document.getElementById('countrySelect');
    const timezoneOffset = document.getElementById('timezoneOffset');
    const countrySearch = document.getElementById('countrySearch');
    const clearSearchBtn = document.getElementById('clearSearch');
    
    // Store all options for filtering
    const allOptions = Array.from(countrySelect.options).slice(1); // Skip first "-- –û–±–µ—Ä—ñ—Ç—å –∫—Ä–∞—ó–Ω—É --"
    
    // Update hidden field when country is selected
    countrySelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const offset = selectedOption.getAttribute('data-offset');
        if (offset) {
            timezoneOffset.value = offset;
        }
    });
    
    // Search functionality
    countrySearch.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        
        // Show/hide clear button
        clearSearchBtn.style.display = searchTerm ? 'block' : 'none';
        
        // Clear all options except the first one
        countrySelect.innerHTML = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å –∫—Ä–∞—ó–Ω—É --</option>';
        
        if (searchTerm === '') {
            // If search is empty, show all options
            allOptions.forEach(option => {
                countrySelect.appendChild(option.cloneNode(true));
            });
        } else {
            // Filter and show matching options
            const filteredOptions = allOptions.filter(option => {
                const optionText = option.textContent.toLowerCase();
                return optionText.includes(searchTerm);
            });
            
            filteredOptions.forEach(option => {
                countrySelect.appendChild(option.cloneNode(true));
            });
            
            // Show message if no results
            if (filteredOptions.length === 0) {
                const noResultOption = document.createElement('option');
                noResultOption.textContent = '–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ';
                noResultOption.disabled = true;
                countrySelect.appendChild(noResultOption);
            }
        }
    });
    
    // Clear search
    clearSearchBtn.addEventListener('click', function() {
        countrySearch.value = '';
        countrySearch.dispatchEvent(new Event('input'));
        countrySearch.focus();
    });
});
</script>
{% endblock %}

{% block content %}
<div class="card shadow-sm mx-auto" style="max-width: 800px;">
    <div class="card-body">
        <h2 class="card-title">–ü—Ä–æ—Ñ—ñ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</h2>
        <div class="row">
            <div class="col-md-6">
                <p><strong>Telegram ID:</strong> {{ user.telegram_id }}</p>
                <p><strong>–ü–æ–≤–Ω–µ —ñ–º'—è:</strong> {{ user.full_name }}</p>
                <p><strong>Username:</strong> @{{ user.telegram_username }}</p>
                <p><strong>–¶—ñ–ª—å —Ç—Ä–µ–Ω—É–≤–∞–Ω—å:</strong> {{ user.training_goal.value }}</p>
                <p>
                    <strong>–°—Ç–∞—Ç—É—Å:</strong>
                    {% if user.is_verified %}‚úÖ –í–µ—Ä–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π {% else %}‚ùå –ù–µ –≤–µ—Ä–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π{% endif %}
                    /
                    {% if user.is_active %}üü¢ –ê–∫—Ç–∏–≤–Ω–∏–π{% else %}üî¥ –ù–µ–∞–∫—Ç–∏–≤–Ω–∏–π{% endif %}
                </p>
            </div>
            
            <div class="col-md-6">
                <!-- –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –æ–ø–ª–∞—Ç—É -->
                <div class="payment-info">
                    <h5><i class="fas fa-credit-card"></i> –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –æ–ø–ª–∞—Ç—É</h5>
                    
                    <div class="mb-3">
                        {% if user.payed_days_left == -1 %}
                            <span class="badge bg-info payment-badge">‚ôæÔ∏è –ë–µ–∑–ª—ñ–º—ñ—Ç–Ω–∏–π –¥–æ—Å—Ç—É–ø</span>
                        {% elif user.payed_days_left == 0 %}
                            <span class="badge bg-secondary payment-badge">‚è∞ –û–ø–ª–∞—Ç–∞ –∑–∞–∫—ñ–Ω—á–∏–ª–∞—Å—å</span>
                        {% elif user.payed_days_left == 1 %}
                            <span class="badge bg-danger payment-badge">‚ö†Ô∏è –ó–∞–ª–∏—à–∏–≤—Å—è 1 –¥–µ–Ω—å</span>
                        {% elif user.payed_days_left <= 7 %}
                            <span class="badge bg-warning payment-badge">‚è∞ –ó–∞–ª–∏—à–∏–ª–æ—Å—å {{ user.payed_days_left }} –¥–Ω—ñ–≤</span>
                        {% else %}
                            <span class="badge bg-success payment-badge">‚úÖ –ó–∞–ª–∏—à–∏–ª–æ—Å—å {{ user.payed_days_left }} –¥–Ω—ñ–≤</span>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <strong>–°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç–∏:</strong>
                        {% if user.paused_payment %}
                            <span class="badge bg-dark">‚è∏Ô∏è –ù–∞ –ø–∞—É–∑—ñ</span>
                        {% else %}
                            <span class="badge bg-success">‚ñ∂Ô∏è –ê–∫—Ç–∏–≤–Ω–∞</span>
                        {% endif %}
                    </div>
                    
                    <div class="payment-actions">
                        <div class="row">
                            <div class="col-12 mb-2">
                                {% if user.paused_payment %}
                                    <form method="post" action="/resume-payment?telegram_id={{ user.telegram_id }}" style="display: inline;">
                                        <button type="submit" class="btn btn-success btn-sm">
                                            <i class="fas fa-play"></i> –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –æ–ø–ª–∞—Ç—É
                                        </button>
                                    </form>
                                {% else %}
                                    <form method="post" action="/pause-payment?telegram_id={{ user.telegram_id }}" style="display: inline;">
                                        <button type="submit" class="btn btn-warning btn-sm">
                                            <i class="fas fa-pause"></i> –ü–æ—Å—Ç–∞–≤–∏—Ç–∏ –Ω–∞ –ø–∞—É–∑—É
                                        </button>
                                    </form>
                                {% endif %}
                            </div>
                            
                            <div class="col-12">
                                <div class="btn-group-vertical w-100" role="group">
                                    <form method="post" action="/add-payment?telegram_id={{ user.telegram_id }}&days=7" style="display: inline;">
                                        <button type="submit" class="btn btn-outline-primary btn-sm w-100 mb-1">
                                            <i class="fas fa-plus"></i> +7 –¥–Ω—ñ–≤
                                        </button>
                                    </form>
                                    
                                    <form method="post" action="/add-payment?telegram_id={{ user.telegram_id }}&days=28" style="display: inline;">
                                        <button type="submit" class="btn btn-primary btn-sm w-100 mb-1">
                                            <i class="fas fa-plus"></i> +28 –¥–Ω—ñ–≤ (1 –º—ñ—Å—è—Ü—å)
                                        </button>
                                    </form>
                                    
                                    <form method="post" action="/add-payment?telegram_id={{ user.telegram_id }}&days=84" style="display: inline;">
                                        <button type="submit" class="btn btn-outline-primary btn-sm w-100 mb-1">
                                            <i class="fas fa-plus"></i> +84 –¥–Ω—ñ (3 –º—ñ—Å—è—Ü—ñ)
                                        </button>
                                    </form>
                                    
                                    {% if user.payed_days_left != -1 %}
                                    <form method="post" action="/set-unlimited?telegram_id={{ user.telegram_id }}" style="display: inline;">
                                        <button type="submit" class="btn btn-info btn-sm w-100" 
                                                onclick="return confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –±–µ–∑–ª—ñ–º—ñ—Ç–Ω–∏–π –¥–æ—Å—Ç—É–ø?')">
                                            <i class="fas fa-infinity"></i> –ë–µ–∑–ª—ñ–º—ñ—Ç–Ω–∏–π –¥–æ—Å—Ç—É–ø
                                        </button>
                                    </form>
                                    {% else %}
                                    <hr class="my-2">
                                    <small class="text-muted">–í—ñ–¥–º—ñ–Ω–∞ –±–µ–∑–ª—ñ–º—ñ—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø—É:</small>
                                    <form method="post" action="/cancel-unlimited?telegram_id={{ user.telegram_id }}&days=28" style="display: inline;">
                                        <button type="submit" class="btn btn-outline-warning btn-sm w-100 mb-1" 
                                                onclick="return confirm('–í—ñ–¥–º—ñ–Ω–∏—Ç–∏ –±–µ–∑–ª—ñ–º—ñ—Ç–Ω–∏–π –¥–æ—Å—Ç—É–ø —ñ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ 28 –¥–Ω—ñ–≤?')">
                                            <i class="fas fa-times-circle"></i> –í—ñ–¥–º—ñ–Ω–∏—Ç–∏ (28 –¥–Ω—ñ–≤)
                                        </button>
                                    </form>
                                    <form method="post" action="/cancel-unlimited?telegram_id={{ user.telegram_id }}&days=0" style="display: inline;">
                                        <button type="submit" class="btn btn-outline-danger btn-sm w-100" 
                                                onclick="return confirm('–í—ñ–¥–º—ñ–Ω–∏—Ç–∏ –±–µ–∑–ª—ñ–º—ñ—Ç–Ω–∏–π –¥–æ—Å—Ç—É–ø —ñ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ 0 –¥–Ω—ñ–≤ (–∑–∞–±–ª–æ–∫—É–≤–∞—Ç–∏)?')">
                                            <i class="fas fa-ban"></i> –í—ñ–¥–º—ñ–Ω–∏—Ç–∏ (0 –¥–Ω—ñ–≤)
                                        </button>
                                    </form>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <hr class="my-4">
        
        <div class="mb-3">
            <a class="btn btn-primary" href="/training-sessions?telegram_id={{ user.telegram_id }}">–¢—Ä–µ–Ω—É–≤–∞–Ω–Ω—è</a>
            <a class="btn btn-secondary" href="/morning-quiz?telegram_id={{ user.telegram_id }}">–†–∞–Ω–∫–æ–≤—ñ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è</a>
            <a class="btn btn-success" href="/statistics?telegram_id={{ user.telegram_id }}">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
            <a class="btn btn-warning" href="/notifications?telegram_id={{ user.telegram_id }}">–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è</a>
        </div>

        <hr class="my-4">

        <!-- –ß–∞—Å–æ–≤–∞ –∑–æ–Ω–∞ —Ç–∞ –∫—Ä–∞—ó–Ω–∞ -->
        <h3><i class="fas fa-globe"></i> –ß–∞—Å–æ–≤–∞ –∑–æ–Ω–∞</h3>
        
        <div class="mb-4">
            {% if user.country and user.timezone_offset is not none %}
                <div class="alert alert-info">
                    <strong>–ü–æ—Ç–æ—á–Ω–∞ –∫—Ä–∞—ó–Ω–∞:</strong> {{ user.country }}<br>
                    <strong>–†—ñ–∑–Ω–∏—Ü—è –∑ –ö–∏—î–≤–æ–º:</strong> 
                    {% if user.timezone_offset > 0 %}
                        +{{ user.timezone_offset }} –≥–æ–¥–∏–Ω
                    {% elif user.timezone_offset < 0 %}
                        {{ user.timezone_offset }} –≥–æ–¥–∏–Ω
                    {% else %}
                        –ö–∏—ó–≤—Å—å–∫–∏–π —á–∞—Å (–±–µ–∑ —Ä—ñ–∑–Ω–∏—Ü—ñ)
                    {% endif %}
                </div>
            {% else %}
                <div class="alert alert-warning">
                    ‚ö†Ô∏è –ß–∞—Å–æ–≤–∞ –∑–æ–Ω–∞ –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
                </div>
            {% endif %}
            
            <form method="post" action="/update-timezone?telegram_id={{ user.telegram_id }}" id="timezoneForm">
                <div class="mb-3">
                    <label for="country" class="form-label">–í–∏–±–µ—Ä—ñ—Ç—å –∫—Ä–∞—ó–Ω—É –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è:</label>
                    
                    <!-- –ü–æ–ª–µ –ø–æ—à—É–∫—É -->
                    <div class="country-search-wrapper">
                        <input type="text" 
                               id="countrySearch" 
                               class="form-control mb-2" 
                               placeholder="üîç –ü–æ—à—É–∫ –∫—Ä–∞—ó–Ω–∏..." 
                               autocomplete="off">
                        <button type="button" id="clearSearch" class="clear-search" title="–û—á–∏—Å—Ç–∏—Ç–∏ –ø–æ—à—É–∫">
                            ‚úï
                        </button>
                    </div>
                    
                    <select name="country" id="countrySelect" class="form-select" required size="8">
                        {% for c in countries %}
                        <option value="{{ c.country }}" data-offset="{{ c.offset }}"
                                {% if user.country == c.country %}selected{% endif %}>
                            {{ c.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <input type="hidden" name="timezone_offset" id="timezoneOffset" value="0">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-clock"></i> –û–Ω–æ–≤–∏—Ç–∏ —á–∞—Å–æ–≤—É –∑–æ–Ω—É
                </button>
            </form>
        </div>

        <hr class="my-4">

        <h3><i class="fas fa-file-alt"></i> –§–∞–π–ª —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è</h3>

        <div class="mb-4">
        {% if user.training_file_url %}
            <div class="alert alert-success d-flex justify-content-between align-items-center">
            <div>
                <strong>‚úÖ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ:</strong>
                <a href="{{ user.training_file_url }}" target="_blank" class="ms-2">
                {{ user.training_file_url.split('/')[-1] }}
                </a>
            </div>
            <button class="btn btn-outline-dark btn-sm"
                    onclick="navigator.clipboard.writeText(window.location.origin + '{{ user.training_file_url }}')">
            üìã –°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è
            </button>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è -->
            <form action="/notify-training-assigned?telegram_id={{ user.telegram_id }}" method="post" class="mt-3">
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-paper-plane"></i> –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
                </button>
            </form>
        {% else %}
            <div class="alert alert-warning">
            üö´ –§–∞–π–ª —â–µ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ.
            </div>
        {% endif %}

        <form action="/upload-training-file?user_telegram_id={{ user.telegram_id }}" method="post" enctype="multipart/form-data" class="mt-3">
            <div class="mb-3">
            <label for="file" class="form-label">–í–∏–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</label>
            <input type="file" name="file" id="file" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-upload"></i> –ü—Ä–∏—Å–≤–æ—ó—Ç–∏ —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è
            </button>
        </form>
        </div>

    </div>
</div>
{% endblock %}

