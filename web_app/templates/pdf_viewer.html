{% extends "base.html" %}

{% block title %}Перегляд тренування - {{ user.full_name }}{% endblock %}

{% block extra_css %}
<style>
    body {
        margin: 0;
        padding: 0;
        overflow: hidden;
    }
    .pdf-viewer-container {
        width: 100%;
        height: calc(100vh - 56px); /* Subtract navbar height */
        position: relative;
        background-color: #525252;
    }
    .pdf-toolbar {
        background-color: #323639;
        padding: 10px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .pdf-toolbar-left,
    .pdf-toolbar-center,
    .pdf-toolbar-right {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .pdf-toolbar button {
        background-color: #454a4e;
        border: none;
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.2s;
    }
    .pdf-toolbar button:hover {
        background-color: #5a6064;
    }
    .pdf-toolbar button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .pdf-toolbar input {
        width: 60px;
        text-align: center;
        background-color: #454a4e;
        border: 1px solid #5a6064;
        color: white;
        padding: 6px;
        border-radius: 4px;
    }
    .pdf-toolbar select {
        background-color: #454a4e;
        border: 1px solid #5a6064;
        color: white;
        padding: 6px 10px;
        border-radius: 4px;
    }
    #pdf-canvas-container {
        width: 100%;
        height: calc(100vh - 116px); /* Subtract navbar + toolbar */
        overflow: auto;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        gap: 10px;
    }
    .pdf-page {
        box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        background-color: white;
        display: block;
        margin-bottom: 10px;
    }
    .loading-message {
        color: white;
        font-size: 18px;
        text-align: center;
        padding: 50px;
    }
</style>
{% endblock %}

{% block content %}
<div class="pdf-viewer-container">
    <div class="pdf-toolbar">
        <div class="pdf-toolbar-left">
            <a href="/profile?telegram_id={{ user.telegram_id }}" class="btn btn-sm btn-outline-light">
                <i class="fas fa-arrow-left"></i> Назад до профілю
            </a>
            <span style="margin-left: 15px;">
                <i class="fas fa-user"></i> {{ user.full_name }}
            </span>
        </div>
        
        <div class="pdf-toolbar-center">
            <button id="prev-page" title="Попередня сторінка">
                <i class="fas fa-chevron-left"></i>
            </button>
            
            <div style="display: flex; align-items: center; gap: 5px;">
                <input type="number" id="page-num" value="1" min="1">
                <span>/ <span id="page-count">0</span></span>
            </div>
            
            <button id="next-page" title="Наступна сторінка">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        
        <div class="pdf-toolbar-right">
            <button id="zoom-out" title="Зменшити">
                <i class="fas fa-search-minus"></i>
            </button>
            
            <select id="zoom-select">
                <option value="0.5">50%</option>
                <option value="0.75">75%</option>
                <option value="1" selected>100%</option>
                <option value="1.25">125%</option>
                <option value="1.5">150%</option>
                <option value="2">200%</option>
                <option value="auto">Авто</option>
                <option value="page-fit">По ширині</option>
            </select>
            
            <button id="zoom-in" title="Збільшити">
                <i class="fas fa-search-plus"></i>
            </button>
            
            <a href="{{ pdf_url }}" download class="btn btn-sm" style="background-color: #454a4e; margin-left: 10px;">
                <i class="fas fa-download"></i> Завантажити
            </a>
        </div>
    </div>
    
    <div id="pdf-canvas-container">
        <div class="loading-message">
            <i class="fas fa-spinner fa-spin"></i> Завантаження PDF...
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- PDF.js library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
// Configure PDF.js worker
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

let pdfDoc = null;
let scale = 1.0;
let canvases = [];

const container = document.getElementById('pdf-canvas-container');

// Load PDF
const pdfUrl = '{{ pdf_url }}';

pdfjsLib.getDocument({
    url: pdfUrl,
    httpHeaders: {
        'ngrok-skip-browser-warning': 'true'
    }
}).promise.then(pdf => {
    pdfDoc = pdf;
    document.getElementById('page-count').textContent = pdf.numPages;
    document.getElementById('page-num').max = pdf.numPages;
    
    // Hide loading message
    container.querySelector('.loading-message').style.display = 'none';
    
    // Render all pages
    renderAllPages();
}).catch(err => {
    console.error('Error loading PDF:', err);
    container.querySelector('.loading-message').innerHTML = 
        '<i class="fas fa-exclamation-triangle"></i> Помилка завантаження PDF: ' + err.message;
});

// Render all pages
function renderAllPages() {
    const promises = [];
    
    for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
        promises.push(renderPage(pageNum));
    }
    
    Promise.all(promises).then(() => {
        console.log('All pages rendered');
        updateCurrentPageIndicator();
    });
}

// Render single page
function renderPage(num) {
    return pdfDoc.getPage(num).then(page => {
        const viewport = page.getViewport({ scale: scale });
        
        const canvas = document.createElement('canvas');
        canvas.className = 'pdf-page';
        canvas.dataset.pageNum = num;
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        
        const ctx = canvas.getContext('2d');
        const renderCtx = {
            canvasContext: ctx,
            viewport: viewport
        };
        
        container.appendChild(canvas);
        canvases.push(canvas);
        
        return page.render(renderCtx).promise;
    });
}

// Update current page indicator based on scroll position
function updateCurrentPageIndicator() {
    const scrollTop = container.scrollTop;
    const containerHeight = container.clientHeight;
    
    let currentPage = 1;
    for (let i = 0; i < canvases.length; i++) {
        const canvas = canvases[i];
        const rect = canvas.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();
        
        if (rect.top <= containerRect.top + containerHeight / 2) {
            currentPage = i + 1;
        }
    }
    
    document.getElementById('page-num').value = currentPage;
}

// Scroll to specific page
function scrollToPage(num) {
    if (num < 1 || num > canvases.length) return;
    
    const canvas = canvases[num - 1];
    canvas.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// Show previous page
document.getElementById('prev-page').addEventListener('click', () => {
    const currentPage = parseInt(document.getElementById('page-num').value);
    if (currentPage <= 1) return;
    scrollToPage(currentPage - 1);
});

// Show next page
document.getElementById('next-page').addEventListener('click', () => {
    const currentPage = parseInt(document.getElementById('page-num').value);
    if (currentPage >= pdfDoc.numPages) return;
    scrollToPage(currentPage + 1);
});

// Page number input
document.getElementById('page-num').addEventListener('change', (e) => {
    let num = parseInt(e.target.value);
    if (num < 1) num = 1;
    if (num > pdfDoc.numPages) num = pdfDoc.numPages;
    scrollToPage(num);
});

// Update page indicator on scroll
container.addEventListener('scroll', updateCurrentPageIndicator);

// Re-render all pages with new scale
function reRenderAllPages() {
    // Clear existing canvases
    canvases.forEach(canvas => canvas.remove());
    canvases = [];
    
    // Render with new scale
    renderAllPages();
}

// Zoom controls
document.getElementById('zoom-in').addEventListener('click', () => {
    scale += 0.25;
    if (scale > 3) scale = 3;
    document.getElementById('zoom-select').value = scale;
    reRenderAllPages();
});

document.getElementById('zoom-out').addEventListener('click', () => {
    scale -= 0.25;
    if (scale < 0.25) scale = 0.25;
    document.getElementById('zoom-select').value = scale;
    reRenderAllPages();
});

document.getElementById('zoom-select').addEventListener('change', (e) => {
    const value = e.target.value;
    
    if (value === 'auto' || value === 'page-fit') {
        // Calculate scale to fit width
        pdfDoc.getPage(1).then(page => {
            const viewport = page.getViewport({ scale: 1 });
            const containerWidth = container.clientWidth - 40; // minus padding
            scale = containerWidth / viewport.width;
            reRenderAllPages();
        });
    } else {
        scale = parseFloat(value);
        reRenderAllPages();
    }
});

// Keyboard navigation
document.addEventListener('keydown', (e) => {
    const currentPage = parseInt(document.getElementById('page-num').value);
    
    if (e.key === 'ArrowUp' && currentPage > 1) {
        scrollToPage(currentPage - 1);
    } else if (e.key === 'ArrowDown' && currentPage < pdfDoc.numPages) {
        scrollToPage(currentPage + 1);
    }
});
</script>
{% endblock %}
