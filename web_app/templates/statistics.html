{% extends "base.html" %}

{% block title %}–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞{% endblock %}

{% block extra_css %}
<style>
.ai-analysis-content {
    line-height: 1.6;
    font-size: 14px;
}

.ai-analysis-content h6 {
    border-bottom: 1px solid #e3f2fd;
    padding-bottom: 5px;
    font-size: 16px;
    font-weight: 600;
}

.ai-analysis-content p {
    margin-bottom: 10px;
}

.ai-analysis-content strong {
    font-weight: 600;
    color: #212529;
}

.ai-analysis-content em {
    font-style: italic;
    color: #6c757d;
}

.ai-analysis-content li {
    margin-left: 20px;
    list-style-type: disc;
    margin-bottom: 5px;
}

.ai-analysis-content ul {
    margin: 0;
    padding: 0;
}

#aiAnalysisCard {
    border-left: 4px solid #28a745;
}

#aiAnalysisCard .card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: {{ user.full_name }} ({{ user.telegram_id }})</h2>
            
            <!-- –§–æ—Ä–º–∞ –¥–ª—è –≤–∏–±–æ—Ä—É –ø–µ—Ä—ñ–æ–¥—É -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="periodType" class="form-label">–¢–∏–ø –ø–µ—Ä—ñ–æ–¥—É:</label>
                            <select class="form-select" id="periodType" onchange="loadStatistics()">
                                <option value="weekly" {% if period_type == 'weekly' %}selected{% endif %}>–¢–∏–∂–Ω–µ–≤–∞</option>
                                <option value="monthly" {% if period_type == 'monthly' %}selected{% endif %}>–ú—ñ—Å—è—á–Ω–∞ (4 —Ç–∏–∂–Ω—ñ)</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="currentPeriodToggle" class="form-label">–ü–µ—Ä—ñ–æ–¥:</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="currentPeriodToggle" onchange="loadStatistics()">
                                <label class="form-check-label" for="currentPeriodToggle">–ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ—Ç–æ—á–Ω–∏–π –ø–µ—Ä—ñ–æ–¥</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label><br>
                            <button class="btn btn-primary" onclick="generateStatistics()">
                                <i class="fas fa-chart-line"></i> –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –∑–∞–Ω–æ–≤–æ
                            </button>
                            <button class="btn btn-info" onclick="loadStatistics()">
                                <i class="fas fa-sync-alt"></i> –û–Ω–æ–≤–∏—Ç–∏
                            </button>
                            <button class="btn btn-success" onclick="generateAiAnalysisDirectly()">
                                <i class="fas fa-robot"></i> AI –ê–Ω–∞–ª—ñ–∑
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI –ê–Ω–∞–ª—ñ–∑ -->
            <div class="card mb-4" id="aiAnalysisCard" style="display: none;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-robot text-success"></i> AI –ê–Ω–∞–ª—ñ–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                    </h5>
                    <small class="text-muted" id="aiAnalysisDate"></small>
                </div>
                <div class="card-body">
                    <!-- –°–ø—ñ–Ω–µ—Ä –¥–ª—è AI –∞–Ω–∞–ª—ñ–∑—É -->
                    <div id="aiAnalysisSpinner" class="text-center" style="display: none;">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">–ì–µ–Ω–µ—Ä–∞—Ü—ñ—è AI –∞–Ω–∞–ª—ñ–∑—É...</span>
                        </div>
                        <p class="mt-2">–ì–µ–Ω–µ—Ä—É—é AI –∞–Ω–∞–ª—ñ–∑... –¶–µ –º–æ–∂–µ –∑–∞–π–Ω—è—Ç–∏ –¥–æ 30 —Å–µ–∫—É–Ω–¥.</p>
                    </div>
                    
                    <div id="aiAnalysisContent" class="ai-analysis-content">
                        <p class="text-muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ AI –∞–Ω–∞–ª—ñ–∑...</p>
                    </div>
                </div>
            </div>

            <!-- –ó–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—á -->
            <div id="loadingSpinner" class="text-center" style="display: none;">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span>
                </div>
                <p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</p>
            </div>

            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
            <div id="statisticsContainer" style="display: none;">
                <!-- –ó–∞–≥–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">–¢—Ä–µ–Ω—É–≤–∞–Ω–Ω—è</h5>
                                <h3 class="text-primary" id="totalTrainings">-</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">–†–∞–Ω–∫–æ–≤—ñ –∫–≤—ñ–∑–∏</h5>
                                <h3 class="text-success" id="totalQuizzes">-</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">–ü–µ—Ä—ñ–æ–¥</h5>
                                <small id="periodRange">-</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ</h5>
                                <small id="generatedAt">-</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –ì—Ä–∞—Ñ—ñ–∫–∏ -->
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-chart-line"></i> –°–∞–º–æ–ø–æ—á—É—Ç—Ç—è</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="wellbeingChart" width="400" height="200"></canvas>
                                <div id="wellbeingStats" class="mt-2"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-chart-bar"></i> –°–æ–Ω</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="sleepChart" width="400" height="200"></canvas>
                                <div id="sleepStats" class="mt-2"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-dumbbell"></i> –°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å —Ç—Ä–µ–Ω—É–≤–∞–Ω—å</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="difficultyChart" width="400" height="200"></canvas>
                                <div id="difficultyStats" class="mt-2"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-brain"></i> –°—Ç—Ä–µ—Å</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="stressChart" width="400" height="200"></canvas>
                                <div id="stressStats" class="mt-2"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-weight"></i> –í–∞–≥–∞</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="weightChart" width="800" height="200"></canvas>
                                <div id="weightStats" class="mt-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫—É -->
            <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>

            <!-- –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –¥–∞–Ω–∏—Ö -->
            <div id="noDataMessage" class="alert alert-info" style="display: none;">
                <h4>–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è</h4>
                <p>–°–ø—Ä–æ–±—É–π—Ç–µ –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∞–±–æ –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ –º–∞—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –¥–∞–Ω—ñ –∑–∞ –æ–±—Ä–∞–Ω–∏–π –ø–µ—Ä—ñ–æ–¥.</p>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let currentUserId = '{{ user.telegram_id }}';
let charts = {};

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
document.addEventListener('DOMContentLoaded', function() {
    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –ø–µ—Ä–µ–º–∏–∫–∞—á –ø–µ—Ä—ñ–æ–¥—É –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º —è–∫ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π (false)
    document.getElementById('currentPeriodToggle').checked = false;
    
    // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –ø–æ–¥—ñ–π –¥–ª—è –ø–µ—Ä–µ–º–∏–∫–∞—á–∞
    document.getElementById('currentPeriodToggle').addEventListener('change', function() {
        const periodLabel = this.checked ? "–ø–æ—Ç–æ—á–Ω–∏–π" : "–ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π";
        document.querySelector('label[for="currentPeriodToggle"]').textContent = `–ü–æ–∫–∞–∑–∞—Ç–∏ ${periodLabel} –ø–µ—Ä—ñ–æ–¥`;
        loadStatistics();
    });
    
    loadStatistics();
});

function showLoading() {
    document.getElementById('loadingSpinner').style.display = 'block';
    document.getElementById('statisticsContainer').style.display = 'none';
    document.getElementById('errorMessage').style.display = 'none';
    document.getElementById('noDataMessage').style.display = 'none';
    document.getElementById('aiAnalysisCard').style.display = 'none';
}

function hideLoading() {
    document.getElementById('loadingSpinner').style.display = 'none';
}

function showError(message) {
    hideLoading();
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorMessage').style.display = 'block';
    document.getElementById('statisticsContainer').style.display = 'none';
    document.getElementById('noDataMessage').style.display = 'none';
}

function showNoData() {
    hideLoading();
    document.getElementById('noDataMessage').style.display = 'block';
    document.getElementById('statisticsContainer').style.display = 'none';
    document.getElementById('errorMessage').style.display = 'none';
}

function showStatistics() {
    hideLoading();
    document.getElementById('statisticsContainer').style.display = 'block';
    document.getElementById('errorMessage').style.display = 'none';
    document.getElementById('noDataMessage').style.display = 'none';
}

async function loadStatistics() {
    showLoading();
    
    const periodType = document.getElementById('periodType').value;
    const currentPeriod = document.getElementById('currentPeriodToggle').checked;
    
    try {
        const response = await fetch(`/api/statistics/user/${currentUserId}?period_type=${periodType}&current_period=${currentPeriod}`);
        
        if (!response.ok) {
            if (response.status === 404) {
                showNoData();
                return;
            }
            throw new Error(`HTTP ${response.status}: ${await response.text()}`);
        }
        
        const data = await response.json();
        displayStatistics(data);
        
        // –û–Ω–æ–≤–ª—é—î–º–æ –ø—ñ–¥–ø–∏—Å –ø–µ—Ä—ñ–æ–¥—É, —â–æ–± –ø–æ–∫–∞–∑–∞—Ç–∏, —â–æ —Ü–µ –ø–æ—Ç–æ—á–Ω–∏–π –ø–µ—Ä—ñ–æ–¥
        if (currentPeriod) {
            document.getElementById('periodRange').innerHTML = 
                `${document.getElementById('periodRange').textContent} <span class="badge bg-info ms-1">–ü–æ—Ç–æ—á–Ω–∏–π</span>`;
        }
        
    } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
        showError('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + error.message);
    }
}

async function generateStatistics() {
    showLoading();
    
    const periodType = document.getElementById('periodType').value;
    const currentPeriod = document.getElementById('currentPeriodToggle').checked;
    
    try {
        const response = await fetch(`/api/statistics/generate/${currentUserId}?period_type=${periodType}&current_period=${currentPeriod}`, {
            method: 'POST'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${await response.text()}`);
        }
        
        const data = await response.json();
        displayStatistics(data);
        
        // –û–Ω–æ–≤–ª—é—î–º–æ –ø—ñ–¥–ø–∏—Å –ø–µ—Ä—ñ–æ–¥—É, —â–æ–± –ø–æ–∫–∞–∑–∞—Ç–∏, —â–æ —Ü–µ –ø–æ—Ç–æ—á–Ω–∏–π –ø–µ—Ä—ñ–æ–¥
        if (currentPeriod) {
            document.getElementById('periodRange').innerHTML = 
                `${document.getElementById('periodRange').textContent} <span class="badge bg-info ms-1">–ü–æ—Ç–æ—á–Ω–∏–π</span>`;
        }
        
    } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
        showError('–ü–æ–º–∏–ª–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + error.message);
    }
}

function displayStatistics(data) {
    // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–∞–≥–∞–ª—å–Ω–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó
    document.getElementById('totalTrainings').textContent = data.total_training_sessions;
    document.getElementById('totalQuizzes').textContent = data.total_morning_quizzes;
    
    const periodStart = new Date(data.period_start).toLocaleDateString('uk-UA');
    const periodEnd = new Date(data.period_end).toLocaleDateString('uk-UA');
    document.getElementById('periodRange').textContent = `${periodStart} - ${periodEnd}`;
    
    const generatedAt = new Date(data.generated_at).toLocaleString('uk-UA');
    document.getElementById('generatedAt').textContent = generatedAt;
    
    // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫—ñ–≤
    if (data.wellbeing_data) {
        createLineChart('wellbeingChart', data.wellbeing_data, '–°–∞–º–æ–ø–æ—á—É—Ç—Ç—è', 'rgba(75, 192, 192, 0.6)');
        displayStats('wellbeingStats', data.wellbeing_data);
    }
    
    if (data.sleep_data) {
        createBarChart('sleepChart', data.sleep_data, '–ì–æ–¥–∏–Ω–∏ —Å–Ω—É', 'rgba(54, 162, 235, 0.6)');
        displaySleepStats('sleepStats', data.sleep_data);
    }
    
    if (data.warehouse_data) {
        createScatterChart('difficultyChart', data.warehouse_data, '–°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å', 'rgba(255, 99, 132, 0.6)');
        displayStats('difficultyStats', data.warehouse_data);
    }
    
    if (data.stress_data) {
        createScatterChart('stressChart', data.stress_data, '–°—Ç—Ä–µ—Å', 'rgba(255, 159, 64, 0.6)');
        displayStats('stressStats', data.stress_data);
    }
    
    if (data.weight_data) {
        createAreaChart('weightChart', data.weight_data, '–í–∞–≥–∞ (–∫–≥)', 'rgba(153, 102, 255, 0.6)');
        displayWeightStats('weightStats', data.weight_data);
    }
    
    showStatistics();
}

function createLineChart(canvasId, data, label, color) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    
    if (charts[canvasId]) {
        charts[canvasId].destroy();
    }
    
    charts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.data_points.map(p => p.date),
            datasets: [{
                label: label,
                data: data.data_points.map(p => p.value),
                borderColor: color,
                backgroundColor: color.replace('0.6', '0.2'),
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 0,
                        maxTicksLimit: 10
                    }
                },
                y: {
                    min: data.y_axis_range[0],
                    max: data.y_axis_range[1],
                    ticks: {
                        callback: function(value) {
                            return Number(value).toFixed(1);
                        }
                    }
                }
            }
        }
    });
}

function createBarChart(canvasId, data, label, color) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    
    if (charts[canvasId]) {
        charts[canvasId].destroy();
    }
    
    charts[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.data_points.map(p => p.date),
            datasets: [{
                label: label,
                data: data.data_points.map(p => p.value),
                backgroundColor: color,
                borderColor: color.replace('0.6', '1'),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 0,
                        maxTicksLimit: 10
                    }
                },
                y: {
                    min: data.y_axis_range[0],
                    max: data.y_axis_range[1],
                    ticks: {
                        callback: function(value) {
                            return Number(value).toFixed(1);
                        }
                    }
                }
            }
        }
    });
}

function createScatterChart(canvasId, data, label, color) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    
    if (charts[canvasId]) {
        charts[canvasId].destroy();
    }
    
    charts[canvasId] = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: label,
                data: data.data_points.map(p => ({x: p.date, y: p.value})),
                backgroundColor: color,
                borderColor: color.replace('0.6', '1'),
                pointRadius: 6
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                x: {
                    type: 'category',
                    ticks: {
                        maxRotation: 45,
                        minRotation: 0,
                        maxTicksLimit: 10
                    }
                },
                y: {
                    min: data.y_axis_range[0],
                    max: data.y_axis_range[1],
                    ticks: {
                        callback: function(value) {
                            return Number(value).toFixed(1);
                        }
                    }
                }
            }
        }
    });
}

function createAreaChart(canvasId, data, label, color) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    
    if (charts[canvasId]) {
        charts[canvasId].destroy();
    }
    
    charts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.data_points.map(p => p.date),
            datasets: [{
                label: label,
                data: data.data_points.map(p => p.value),
                borderColor: color,
                backgroundColor: color.replace('0.6', '0.3'),
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 0,
                        maxTicksLimit: 10
                    }
                },
                y: {
                    min: data.y_axis_range[0],
                    max: data.y_axis_range[1],
                    ticks: {
                        callback: function(value) {
                            return Number(value).toFixed(1);
                        }
                    }
                }
            }
        }
    });
}

function displayStats(elementId, data) {
    const element = document.getElementById(elementId);
    let html = `<small class="text-muted">–°–µ—Ä–µ–¥–Ω—î: ${data.average}</small>`;
    
    if (data.trend) {
        const trendText = {
            'stable': '–°—Ç–∞–±—ñ–ª—å–Ω–∏–π',
            'increasing': '–ó—Ä–æ—Å—Ç–∞—î',
            'decreasing': '–ó–Ω–∏–∂—É—î—Ç—å—Å—è',
            'fluctuating': '–ö–æ–ª–∏–≤–∞—î—Ç—å—Å—è'
        };
        html += ` | <small class="text-muted">–¢—Ä–µ–Ω–¥: ${trendText[data.trend] || data.trend}</small>`;
    }
    
    element.innerHTML = html;
}

function displaySleepStats(elementId, data) {
    const element = document.getElementById(elementId);
    let html = `<small class="text-muted">–°–µ—Ä–µ–¥–Ω—î: ${data.average} –≥–æ–¥</small>`;
    
    if (data.total_sleep_hours) {
        html += ` | <small class="text-muted">–ó–∞–≥–∞–ª–æ–º: ${data.total_sleep_hours} –≥–æ–¥</small>`;
    }
    
    element.innerHTML = html;
}

function displayWeightStats(elementId, data) {
    const element = document.getElementById(elementId);
    let html = '';
    
    if (data.start_weight) {
        html += `<small class="text-muted">–ü–æ—á–∞—Ç–∫–æ–≤–∞: ${data.start_weight} –∫–≥</small>`;
    }
    
    if (data.end_weight) {
        html += ` | <small class="text-muted">–ö—ñ–Ω—Ü–µ–≤–∞: ${data.end_weight} –∫–≥</small>`;
    }
    
    if (data.weight_change !== undefined) {
        const changeClass = data.weight_change > 0 ? 'text-success' : data.weight_change < 0 ? 'text-danger' : 'text-muted';
        const changeSign = data.weight_change > 0 ? '+' : '';
        html += ` | <small class="${changeClass}">–ó–º—ñ–Ω–∞: ${changeSign}${data.weight_change} –∫–≥</small>`;
    }
    
    if (data.trend) {
        const trendText = {
            'stable': '–°—Ç–∞–±—ñ–ª—å–Ω–∞',
            'increasing': '–ó—Ä–æ—Å—Ç–∞—î',
            'decreasing': '–ó–Ω–∏–∂—É—î—Ç—å—Å—è'
        };
        html += ` | <small class="text-muted">–¢—Ä–µ–Ω–¥: ${trendText[data.trend] || data.trend}</small>`;
    }
    
    document.getElementById(elementId).innerHTML = html;
}

// AI –ê–Ω–∞–ª—ñ–∑ —Ñ—É–Ω–∫—Ü—ñ—ó
async function generateAiAnalysisDirectly() {
    try {
        // –û—Ç—Ä–∏–º—É—î–º–æ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é AI
        const configResponse = await fetch('/api/statistics/ai-config', {
            credentials: 'include'
        });
        
        if (!configResponse.ok) {
            throw new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é AI');
        }
        
        const config = await configResponse.json();
        
        if (!config.has_api_key || !config.has_assistant_id) {
            alert('AI –∞–Ω–∞–ª—ñ–∑ –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π. API –∫–ª—é—á –∞–±–æ ID –∞—Å–∏—Å—Ç–µ–Ω—Ç–∞ –≤—ñ–¥—Å—É—Ç–Ω—ñ –≤ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó —Å–µ—Ä–≤–µ—Ä–∞.');
            return;
        }
        
        const periodType = document.getElementById('periodType').value;
        const currentPeriod = document.getElementById('currentPeriodToggle').checked;
        const userId = currentUserId;
        
        // –ü–æ–∫–∞–∑—É—î–º–æ –∫–∞—Ä—Ç–∫—É –∑ —Å–ø—ñ–Ω–µ—Ä–æ–º
        document.getElementById('aiAnalysisCard').style.display = 'block';
        document.getElementById('aiAnalysisSpinner').style.display = 'block';
        document.getElementById('aiAnalysisContent').style.display = 'none';
        
        // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∑–∞–ø–∏—Ç
        const response = await fetch(`/api/statistics/generate-with-ai/${userId}?period_type=${periodType}&current_period=${currentPeriod}`, {
            method: 'POST',
            credentials: 'include'
        });
        
        const data = await response.json();
        
        if (data.ai_analysis) {
            displayAiAnalysis(data.ai_analysis, data.ai_analysis_generated_at);
        } else {
            document.getElementById('aiAnalysisContent').innerHTML = 
                '<p class="text-warning">AI –∞–Ω–∞–ª—ñ–∑ –Ω–µ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.</p>';
            document.getElementById('aiAnalysisContent').style.display = 'block';
        }
        
    } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞:', error);
        document.getElementById('aiAnalysisCard').style.display = 'block';
        document.getElementById('aiAnalysisSpinner').style.display = 'none';
        document.getElementById('aiAnalysisContent').innerHTML = 
            '<p class="text-danger">–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó AI –∞–Ω–∞–ª—ñ–∑—É: ' + error.message + '</p>';
        document.getElementById('aiAnalysisContent').style.display = 'block';
    }
}

function displayAiAnalysis(analysis, generatedAt) {
    document.getElementById('aiAnalysisSpinner').style.display = 'none';
    document.getElementById('aiAnalysisContent').style.display = 'block';
    document.getElementById('aiAnalysisContent').innerHTML = formatAiAnalysis(analysis);
    
    if (generatedAt) {
        const date = new Date(generatedAt);
        document.getElementById('aiAnalysisDate').textContent = 
            `–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ: ${date.toLocaleDateString('uk-UA')} ${date.toLocaleTimeString('uk-UA')}`;
    }
}

function formatAiAnalysis(analysis) {
    // –§–æ—Ä–º–∞—Ç—É—î–º–æ —Ç–µ–∫—Å—Ç –∞–Ω–∞–ª—ñ–∑—É –∑ —Ä–æ–∑–±–∏—Ç—Ç—è–º –Ω–∞ –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∏ —Ç–∞ HTML —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è–º
    return analysis
        .split('\n')
        .filter(line => line.trim())
        .map(line => {
            line = line.trim();
            
            // –û–±—Ä–æ–±–ª—è—î–º–æ –∂–∏—Ä–Ω–∏–π —Ç–µ–∫—Å—Ç **text**
            line = line.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // –û–±—Ä–æ–±–ª—è—î–º–æ –∫—É—Ä—Å–∏–≤ *text*
            line = line.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // –û–±—Ä–æ–±–ª—è—î–º–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏
            if (line.startsWith('##') || line.startsWith('**')) {
                return `<h6 class="mt-3 mb-2">${line.replace(/[#*]/g, '')}</h6>`;
            } 
            // –û–±—Ä–æ–±–ª—è—î–º–æ —Å–ø–∏—Å–∫–∏
            else if (line.startsWith('-') || line.startsWith('‚Ä¢')) {
                return `<li class="mb-1">${line.replace(/^[-‚Ä¢]\s*/, '')}</li>`;
            } 
            // –û–±—Ä–æ–±–ª—è—î–º–æ –µ–º–æ–¥–∑—ñ –∑–∞–≥–æ–ª–æ–≤–∫–∏
            else if (/^[‚ö°Ô∏èüèãÔ∏è‚Äç‚ôÇÔ∏èüí§üòåüìâüìåüî•üí™üöÄ]/.test(line)) {
                return `<h6 class="mt-3 mb-2">${line}</h6>`;
            }
            // –ó–≤–∏—á–∞–π–Ω—ñ –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∏
            else {
                return `<p class="mb-2">${line}</p>`;
            }
        })
        .join('');
}

// –û–Ω–æ–≤–ª—é—î–º–æ —Ñ—É–Ω–∫—Ü—ñ—é displayStatistics –¥–ª—è –ø–æ–∫–∞–∑—É AI –∞–Ω–∞–ª—ñ–∑—É
const originalDisplayStatistics = window.displayStatistics;
window.displayStatistics = function(data) {
    originalDisplayStatistics(data);
    
    // –ó–∞–≤–∂–¥–∏ –ø–æ–∫–∞–∑—É—î–º–æ –∫–∞—Ä—Ç–∫—É AI –∞–Ω–∞–ª—ñ–∑—É
    document.getElementById('aiAnalysisCard').style.display = 'block';
    document.getElementById('aiAnalysisSpinner').style.display = 'none';
    
    // –ü–æ–∫–∞–∑—É—î–º–æ AI –∞–Ω–∞–ª—ñ–∑ —è–∫—â–æ –≤—ñ–Ω —î, —ñ–Ω–∞–∫—à–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—é
    if (data.ai_analysis) {
        displayAiAnalysis(data.ai_analysis, data.ai_analysis_generated_at);
    } else {
        document.getElementById('aiAnalysisContent').style.display = 'block';
        document.getElementById('aiAnalysisContent').innerHTML = 
            '<p class="text-muted"><i class="fas fa-info-circle"></i> AI –∞–Ω–∞–ª—ñ–∑ —â–µ –Ω–µ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ –¥–ª—è —Ü—å–æ–≥–æ –ø–µ—Ä—ñ–æ–¥—É. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É "AI –ê–Ω–∞–ª—ñ–∑" –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó.</p>';
        document.getElementById('aiAnalysisDate').textContent = '';
    }
}
</script>
{% endblock %}
